System.register("config",[],function(){"use strict";var e=!0,t=60,r="js/app/assets/";return{get _DEBUG_MODE_(){return e},get _FPS_(){return t},get _ASSETS_PATH_(){return r}}}),System.register("util",[],function(){"use strict";function e(e){if(c._DEBUG_MODE_){var t=new Date,r=t.getHours(),n=t.getMinutes(),i=t.getSeconds(),a=t.getMilliseconds(),s=r+":"+n+":"+i+":"+a;console.log(s+" "+e)}}function t(e){if(c._DEBUG_MODE_){var t=new Date,r=t.getHours(),n=t.getMinutes(),i=t.getSeconds(),a=t.getMilliseconds(),s=r+":"+n+":"+i+":"+a;$("#debug_board").html(s+" "+e)}}function r(e){var t=e.context,r={Version:t.getParameter(t.VERSION),"Shading language":t.getParameter(t.SHADING_LANGUAGE_VERSION),Vendor:t.getParameter(t.VENDOR),Renderer:t.getParameter(t.RENDERER),"Max varying vectors":t.getParameter(t.MAX_VARYING_VECTORS),"Max vertex attribs":t.getParameter(t.MAX_VERTEX_ATTRIBS),"Max vertex uniform vectors":t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),"Max fragment uniform vectors":t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),"Max renderbuffer size":t.getParameter(t.MAX_RENDERBUFFER_SIZE),"Max texture size":t.getParameter(t.MAX_TEXTURE_SIZE),"Max cube map texture size":t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),"Max texture image units":t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),"Max vertex texture units":t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),"Max combined texture units":t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),"Max viewport dims":t.getParameter(t.MAX_VIEWPORT_DIMS)[0]+"x"+t.getParameter(t.MAX_VIEWPORT_DIMS)[1]};console.log("WebGL info: ",r)}function n(e,t){var r=t?"image/jpeg":"image/png",n=renderer.domElement.toDataURL(r);e||(n=n.replace(r,"image/octet-stream")),window.open(n,"_blank")}function i(e,t,r,n,i){var a=$("<div>"+e+"</div>"),s={};s[r]=function(){$(this).dialog("close"),i(!1),$(this).dialog("destroy")},s[n]=function(){$(this).dialog("close"),i(!0),$(this).dialog("destroy")},a.dialog({modal:!0,draggable:!0,title:t,height:180,width:500,buttons:s,open:function(){var e=$(".ui-dialog-titlebar-close");e.append('<span class="ui-button-icon-primary ui-icon ui-icon-closethick"></span><span class="ui-button-text">close</span>')},overlay:{opacity:.3,background:"#225b7f"}})}function a(e,t,r,n,i){var a=$("<div>"+e+"</div>"),s={};s[r]=function(){$(this).dialog("close"),i(!1),$(this).dialog("destroy")},s[n]=function(){$(this).dialog("close"),i(!0),$(this).dialog("destroy")},a.dialog({modal:!0,draggable:!0,title:t,width:500,buttons:s,open:function(){var e=$(".ui-dialog-titlebar-close");e.append('<span class="ui-button-icon-primary ui-icon ui-icon-closethick"></span><span class="ui-button-text">close</span>')},overlay:{opacity:.3,background:"#225b7f"}})}function s(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,s)}function o(e){$.i18n.init({ns:{namespaces:["ns.special"],defaultNs:"ns.special"},useLocalStorage:!1,debug:!0},function(){e()})}var c=System.get("config"),h=function(){};return $traceurRuntime.createClass(h,{hoge:function(){console.log("Hoge::hoge")}},{}),{get trace_func(){return e},get debug_board(){return t},get webgl_info(){return r},get screenshot(){return n},get Hoge(){return h},get confirmDialog(){return i},get myDialog(){return a},get uuid(){return s},get i18nLoad(){return o}}}),System.register("objects/ratamahatta",[],function(){"use strict";var e=System.get("util"),t=System.get("config"),r=function(r,n){e.trace_func("Ratamahatta::constructor"),this.cur_animation=null;var i={baseUrl:t._ASSETS_PATH_+"models/ratamahatta/",body:"ratamahatta.js",skins:["ratamahatta.png","ctf_b.png","ctf_r.png","dead.png","gearwhore.png"],weapons:[["weapon.js","weapon.png"],["w_bfg.js","w_bfg.png"],["w_blaster.js","w_blaster.png"],["w_chaingun.js","w_chaingun.png"],["w_glauncher.js","w_glauncher.png"],["w_hyperblaster.js","w_hyperblaster.png"],["w_machinegun.js","w_machinegun.png"],["w_railgun.js","w_railgun.png"],["w_rlauncher.js","w_rlauncher.png"],["w_shotgun.js","w_shotgun.png"],["w_sshotgun.js","w_sshotgun.png"]]};this.callback_function=n,this.character=new THREE.MD2Character,this.character.scale=r;var a=this;this.character.onLoadComplete=function(){a.setSkin(0),a.setWeapon(0),a.setAnimation("stand"),a.cur_animation="stand",n(a.character.root,a)},this.character.loadParts(i)};return $traceurRuntime.createClass(r,{rendering:function(e){this.character.update(e)},getRatamahatta:function(){return this.character},setAnimation:function(e){this.cur_animation=e,this.character.setAnimation(e)},getAnimation:function(){return this.cur_animation},setSkin:function(e){this.character.setSkin(e)},setWeapon:function(e){this.character.setWeapon(e)}},{}),{get Ratamahatta(){return r}}}),System.register("openingscene",[],function(){"use strict";var e=System.get("util"),t=(System.get("config"),System.get("objects/ratamahatta")),r=function(t){e.trace_func("OpeningScene::constructor"),this.renderer,this.scene,this.camera,this.keyboard=new THREEx.KeyboardState,this.nextScene="own",this.all_items=1,this.loaded_items=0,this.render_target_array=new Array,this.renderer=t,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,1,.1,1e5),this.camera.position.set(-20,10,250),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.light=new THREE.SpotLight(16777215),this.light.position.set(100,1e3,0),this.light.angle=Math.PI/4,this.scene.add(this.light),this.light.castShadow=!0,this.light.shadowMapWidth=1024,this.light.shadowMapHeight=1024,this.light.shadowCameraNear=100,this.light.shadowCameraFar=1100,this.light.shadowCameraFov=30,this.light.shadowCameraVisible=!1,this.renderer.shadowMapEnabled=!0,$(document.body).append('<div id="openingscene_storybox"></div>'),$("#openingscene_storybox").append("<div>story...</div>"),$("#openingscene_storybox").append("<div>昔々、あるところにおじいさんとおばあさんが住んでいました。</div>"),$("#openingscene_storybox").append("<div>おじいさんは芝刈りに、おばあさんは川に洗濯にいきました。</div>"),$("#openingscene_storybox").append("<div>おばあさんが川で洗濯をしていると、ドンブラコ、ドンブラコと、大きな桃が流れてきました。</div>"),$("#openingscene_storybox").append("<div>おじいさんとおばあさんが桃を食べようと切ってみると、なんと中から銃をもった小さな緑の男の子が現れました。</div>"),$("#openingscene_storybox").append("<div>子どものいなかったおじいさんとおばあさんは、大喜びです。</div>"),$("#openingscene_storybox").append("<div>桃から生まれた男の子を、おじいさんとおばあさんは桃太郎と名付けました。</div>"),$("#openingscene_storybox").append("<div>桃太郎はスクスク育って、やがて強い男の子になりました。</div>"),$("#openingscene_storybox").append("<div>そしてある日、桃太郎が言いました。</div>"),$("#openingscene_storybox").append("<div>「ぼく、鬼ヶ島へ行って、わるい鬼を退治します」</div>"),this.loadObjects()};return $traceurRuntime.createClass(r,{destructor:function(){this.scene=null,delete this.scene},getLoadingStatus:function(){return this.all_items===this.loaded_items||0==this.loading?(e.debug_board("complete"),!0):!1},loadedIncrements:function(){this.loaded_items++,this.loaded_items===this.all_items&&(this.loading=!1,this.clock=new THREE.Clock)},getNextScene:function(){return this.nextScene},start:function(){$("#openingscene_storybox").remove(),this.nextScene="testscene"},rendering:function(){var e=this.clock.getDelta();this.keyboard.pressed("enter")&&this.start();for(var t=0;t<this.render_target_array.length;t++)this.render_target_array[t].rendering(e);this.renderer.render(this.scene,this.camera)},loadObjects:function(){var e=this;this.user_character=new t.Ratamahatta(1,function(t){t.name="player",e.scene.add(t),e.loadedIncrements()}),this.render_target_array.push(this.user_character)},resize:function(){e.trace_func("OpeningScene::resize"),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()},mousedown:function(){this.start()}},{}),{get OpeningScene(){return r}}}),System.register("startscene",[],function(){"use strict";var e=System.get("util"),t=(System.get("config"),function(t){var r=this;e.trace_func("StartScene::constructor"),this.renderer,this.scene,this.camera,this.keyboard=new THREEx.KeyboardState,this.nextScene="own",this.renderer=t,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,1,.1,1e5),this.camera.position.set(0,150,500),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),$(document.body).append('<div id="startscene_background"></div>'),$(document.body).append('<div id="startscene_mainbox"></div>'),$("#startscene_mainbox").append('<h1 id="startscene_title">The Game</h1>'),$("#startscene_mainbox").append('<p id="startscene_start">start</p>'),$("#startscene_mainbox").append('<p id="startscene_load">load</p>'),$("#startscene_mainbox").append('<p id="startscene_config">config</p>'),$("#startscene_start").on("click",function(){r.start()}),e.debug_board("complete")});return $traceurRuntime.createClass(t,{destructor:function(){this.scene=null,delete this.scene},getLoadingStatus:function(){return!0},getNextScene:function(){return this.nextScene},start:function(){$("#startscene_start").off(),$("#startscene_background").remove(),$("#startscene_mainbox").remove(),this.nextScene="openingscene"},rendering:function(){this.keyboard.pressed("up"),this.keyboard.pressed("down"),this.keyboard.pressed("enter")&&this.start(),this.renderer.render(this.scene,this.camera)},resize:function(){e.trace_func("StartScene::resize"),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()},mousedown:function(){}},{}),{get StartScene(){return t}}}),System.register("objects/debugbox",[],function(){"use strict";var e=System.get("util"),t=(System.get("config"),function(t){e.trace_func("Debugbox::constructor"),this.callback_function=t,this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,100,100),new THREE.MeshPhongMaterial({color:65280})),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.callback_function(this.mesh)});return $traceurRuntime.createClass(t,{rendering:function(e){this.mesh.rotation.y+=e}},{}),{get Debugbox(){return t}}}),System.register("objects/shaderbox",[],function(){"use strict";var e=System.get("util"),t=System.get("config"),r=function(r,n,i){e.trace_func("Shaderbox::constructor"),this.callback_function=i;var a=new THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"cover.png"),s=!0,o=!1,c=!1;s===!0?o=!0:c=!0,this.customUniforms={baseTexture:{type:"t",value:a},time:{type:"f",value:1},grayscale:{type:"i",value:c},sepia:{type:"i",value:o}};var h=new THREE.ShaderMaterial({uniforms:this.customUniforms,vertexShader:r,fragmentShader:n});this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,100,100),h),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.callback_function(this.mesh)};return $traceurRuntime.createClass(r,{rendering:function(e){this.mesh.rotation.y+=e,this.customUniforms.time.value+=e}},{}),{get Shaderbox(){return r}}}),System.register("objects/skybox",[],function(){"use strict";var e=System.get("util"),t=System.get("config"),r=function(r){e.trace_func("Skybox::constructor"),this.callback_function=r;var n=new THREE.BoxGeometry(15e3,15e3,15e3),i=[];i.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"skybox/skybox_px.jpg"),side:THREE.BackSide})),i.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"skybox/skybox_nx.jpg"),side:THREE.BackSide})),i.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"skybox/skybox_py.jpg"),side:THREE.BackSide})),i.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"skybox/skybox_ny.jpg"),side:THREE.BackSide})),i.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"skybox/skybox_pz.jpg"),side:THREE.BackSide})),i.push(new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"skybox/skybox_nz.jpg"),side:THREE.BackSide}));var a=new THREE.MeshFaceMaterial(i);this.mesh=new THREE.Mesh(n,a),this.callback_function(this.mesh)};return $traceurRuntime.createClass(r,{},{}),{get Skybox(){return r}}}),System.register("objects/terrain",[],function(){"use strict";var e=System.get("util"),t=System.get("config"),r=function(r){e.trace_func("Terrain::constructor"),this.mesh,this.callback_function=r;var n=-1e3,i=new Image,a=this;i.onload=function(){for(var e=a.getHeightData(i),t=new THREE.PlaneGeometry(100,100,127,127),r=0,s=t.vertices.length;s>r;r++)t.vertices[r].z=e[r];a.mesh=a.addMesh(t,100,0,n,0,-1.57,0,0,a.getTerrainMaterial()),a.mesh.receiveShadow=!0,a.callback_function(a.mesh)},i.src=t._ASSETS_PATH_+"heightmap/heightmap_128.jpg";for(var s=new THREE.PlaneGeometry(100,100,1,1),o=0;o<s.faces.length;o++)for(var c=s.faces[1],h=0,d=c.length;d>h;h++)c[h].u*=10,c[h].v*=10;this.addMesh(s,63,-1e3,n+620,1e3,-1.57,0,0,this.getWaterMaterial())};return $traceurRuntime.createClass(r,{getMesh:function(){return this.mesh},getHeightData:function(e){var t=document.createElement("canvas");t.width=128,t.height=128;var r=t.getContext("2d"),n=16384,i=new Float32Array(n);r.drawImage(e,0,0);for(var a=0;n>a;a++)i[a]=0;for(var s=r.getImageData(0,0,128,128),o=s.data,c=0,a=0,h=o.length;h>a;a+=4){var d=o[a]+o[a+1]+o[a+2];i[c++]=d/30}return i},addMesh:function(e,t,r,n,i,a,s,o,c){var h=new THREE.Mesh(e,c);return h.scale.x=h.scale.y=h.scale.z=t,h.position.x=r,h.position.y=n,h.position.z=i,h.rotation.x=a,h.rotation.y=s,h.rotation.z=o,h.overdraw=!0,h.doubleSided=!1,h.updateMatrix(),h},getTerrainMaterial:function(){var e=new THREE.MeshPhongMaterial({map:new THREE.Texture(null,THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping),ambient:11184810,specular:16777215,shininess:0,shading:THREE.SmoothShading});return e.map=THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"heightmap/terrain.jpg"),e},getWaterMaterial:function(){var e=new THREE.MeshPhongMaterial({map:new THREE.Texture(null,THREE.UVMapping,THREE.RepeatWrapping,THREE.RepeatWrapping),ambient:6710886,specular:16777215,reflectivity:.15,shininess:10,shading:THREE.SmoothShading});return e.map=THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"heightmap/water.jpg"),e},rendering:function(){}},{}),{get Terrain(){return r}}}),System.register("testscene",[],function(){"use strict";var e=System.get("util"),t=System.get("config"),r=System.get("objects/debugbox"),n=System.get("objects/shaderbox"),i=System.get("objects/terrain"),a=System.get("objects/skybox"),s=System.get("objects/ratamahatta"),o=!0,c=!1,h=function(t){e.trace_func("TestScene::constructor"),this.renderer,this.scene,this.camera,this.light,this.ambient,this.all_items=6,this.loaded_items=0,this.nextScene="own",this.render_target_array=new Array,this.clock,this.water=null,this.keyboard=new THREEx.KeyboardState,this.user_character=null,this.grounds_collision_array=new Array,this.walls_collision_array=new Array,this.mouseLook={x:0,y:0},this.gravity=new THREE.Vector3(0,-10,0),this.cur_anim_name="stand",this.attack_delta=0,this.monsters_array=new Array,this.renderer=t,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,1,.1,1e5),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.light=new THREE.SpotLight(16777215),this.light.position.set(100,1e3,0),this.light.angle=Math.PI/4,this.scene.add(this.light),this.light.castShadow=!0,this.light.shadowMapWidth=1024,this.light.shadowMapHeight=1024,this.light.shadowCameraNear=100,this.light.shadowCameraFar=1100,this.light.shadowCameraFov=30,this.light.shadowCameraVisible=!0,this.renderer.shadowMapEnabled=!0,this.loadObjects(),o&&(this.trackball=new THREE.TrackballControls(this.camera))};return $traceurRuntime.createClass(h,{destructor:function(){this.scene=null,delete this.scene},getLoadingStatus:function(){return this.all_items===this.loaded_items||0==this.loading?!0:!1},loadedIncrements:function(){this.loaded_items++,this.loaded_items===this.all_items&&(this.loading=!1,this.clock=new THREE.Clock)},getNextScene:function(){return this.nextScene},rendering:function(){o&&this.trackball.update();var t=this.clock.getDelta();if(!(t>1)){this.attack_delta>=0&&this.attack_delta--,this.attack_delta<0&&"attack"==this.cur_anim_name&&(this.cur_anim_name="stand",this.user_character.setAnimation("stand"));var r={xDist:0,yAngle:0,zDist:0},n=200*t,i=Math.PI/4*t,a=!1;this.keyboard.pressed("W")&&"attack"!=this.cur_anim_name&&(e.trace_func("UP"),"run"!=this.cur_anim_name&&"jump"!=this.cur_anim_name&&(this.cur_anim_name="run",this.user_character.setAnimation("run")),r.zDist+=n,a=!0),this.keyboard.pressed("A")&&"attack"!=this.cur_anim_name&&(e.trace_func("LEFT"),"run"!=this.cur_anim_name&&"jump"!=this.cur_anim_name&&(this.cur_anim_name="run",this.user_character.setAnimation("run")),r.xDist+=n,a=!0),this.keyboard.pressed("S")&&"attack"!=this.cur_anim_name&&(e.trace_func("DOWN"),"run"!=this.cur_anim_name&&"jump"!=this.cur_anim_name&&(this.cur_anim_name="run",this.user_character.setAnimation("run")),r.zDist-=n,a=!0),this.keyboard.pressed("D")&&"attack"!=this.cur_anim_name&&(e.trace_func("RIGHT"),"run"!=this.cur_anim_name&&"jump"!=this.cur_anim_name&&(this.cur_anim_name="run",this.user_character.setAnimation("run")),r.xDist-=n,a=!0),this.keyboard.pressed("Q")&&"attack"!=this.cur_anim_name&&(e.trace_func("TURN LEFT"),"run"!=this.cur_anim_name&&"jump"!=this.cur_anim_name&&(this.cur_anim_name="run",this.user_character.setAnimation("run")),r.yAngle+=i,a=!0),this.keyboard.pressed("E")&&"attack"!=this.cur_anim_name&&(e.trace_func("TURN RIGHT"),"run"!=this.cur_anim_name&&"jump"!=this.cur_anim_name&&(this.cur_anim_name="run",this.user_character.setAnimation("run")),r.yAngle-=i,a=!0),a||"attack"==this.cur_anim_name||"jump"==this.cur_anim_name||"stand"!=this.cur_anim_name&&(this.cur_anim_name="stand",this.user_character.setAnimation("stand")),r.yAngle-=i*this.mouseLook.x*.1,this.mouseLook.x=0;var s=this.user_character.getRatamahatta();s.root.translateZ(r.zDist),s.root.rotateY(r.yAngle),s.root.translateX(r.xDist),s.root.updateMatrix();var h=new THREE.Vector3(s.root.position.x,s.root.position.y,s.root.position.z),d=this.collision(h,this.walls_collision_array);if(d&&(s.root.translateX(-r.xDist),s.root.rotateY(-r.yAngle),s.root.translateZ(-r.zDist),s.root.updateMatrix()),c){this.keyboard.pressed("space")&&0==s.root.velocity.y&&(e.trace_func("JUMP"),"jump"!=this.cur_anim_name&&(this.cur_anim_name="jump",this.user_character.setAnimation("jump")),s.root.velocity=new THREE.Vector3(0,3,0)),s.root.velocity.add(this.gravity.clone().multiplyScalar(t)),s.root.translateY(s.root.velocity.y),s.root.updateMatrix();var u=new THREE.Raycaster;u.ray.direction.set(0,-1,0);var l=new THREE.Vector3(s.root.position.x,s.root.position.y-20,s.root.position.z);u.ray.origin.copy(l);var m=u.intersectObjects(this.grounds_collision_array);if(m.length>0){var p=m[0].distance;console.log(p),e.debug_board("delta: "+t+" distance:"+p+" point.y:"+m[0].point.y+"<br>person x:"+s.root.position.x+" y:"+s.root.position.y+" z:"+s.root.position.z),p>0&&10>p&&("jump"==this.cur_anim_name&&(this.cur_anim_name="stand",this.user_character.setAnimation("stand")),s.root.translateY(-s.root.velocity.y),s.root.updateMatrix(),s.root.velocity=new THREE.Vector3(0,0,0))}else e.debug_board("落下!")}if(!c){var u=new THREE.Raycaster;u.ray.direction.set(0,-1,0);var g=new THREE.Vector3(s.root.position.x,s.root.position.y+50,s.root.position.z);u.ray.origin.copy(g);var m=u.intersectObjects(this.grounds_collision_array);m.length>0&&(s.root.position.y=m[0].point.y+25)}e.debug_board("delta: "+Math.floor(1e5*t)/1e5+"<br><br>person x:"+Math.floor(1e5*s.root.position.x)/1e5+" y:"+Math.floor(1e5*s.root.position.y)/1e5+" z:"+Math.floor(1e5*s.root.position.z)/1e5+"<br>info.memory.programs:"+this.renderer.info.memory.programs+"<br>info.memory.geometries:"+this.renderer.info.memory.geometries+"<br>info.memory.textures:"+this.renderer.info.memory.textures+"<br>info.render.calls:"+this.renderer.info.render.calls+"<br>info.render.vertices:"+this.renderer.info.render.vertices+"<br>info.render.faces:"+this.renderer.info.render.faces+"<br>info.render.points:"+this.renderer.info.render.points),this.light.position.set(s.root.position.x,s.root.position.y+1e3,s.root.position.z),this.light.target.position.set(s.root.position.x,s.root.position.y-25,s.root.position.z),s.root.position.x>=50&&s.root.position.x<=100&&s.root.position.z>=500&&s.root.position.z<=800&&(this.nextScene="threefieldscene");for(var _=0;_<this.render_target_array.length;_++)this.render_target_array[_].rendering(t);this.water.material.uniforms.time.value+=1/60,this.renderer.render(this.scene,this.camera)}},collision:function(e,t){var r=new THREE.Raycaster;r.ray.direction.set(0,0,-1),r.ray.origin.copy(e);var n=r.intersectObjects(t);if(n.length>0){var i=n[0].distance;if(i>0&&10>i)return!0}r.ray.direction.set(0,0,1),r.ray.origin.copy(e);var n=r.intersectObjects(t);if(n.length>0){var i=n[0].distance;if(i>0&&10>i)return!0}r.ray.direction.set(-1,0,0),r.ray.origin.copy(e);var n=r.intersectObjects(t);if(n.length>0){var i=n[0].distance;if(i>0&&10>i)return!0}r.ray.direction.set(1,0,0),r.ray.origin.copy(e);var n=r.intersectObjects(t);if(n.length>0){var i=n[0].distance;if(i>0&&10>i)return!0}return!1},loadObjects:function(){var e=this,o=new r.Debugbox(function(t){t.position.y+=70,e.scene.add(t),e.loadedIncrements(),e.grounds_collision_array.push(t)});this.render_target_array.push(o);new r.Debugbox(function(t){t.position.x=83,t.position.y=190,t.position.z=716,e.scene.add(t),e.loadedIncrements(),e.walls_collision_array.push(t)});SHADER_LOADER.load(function(t){var r=t.vertexShader.vertex,i=t.fragmentShader.fragment,a=new n.Shaderbox(r,i,function(t){t.position.y+=70,t.position.x+=120,e.scene.add(t),e.loadedIncrements(),e.grounds_collision_array.push(t)});e.render_target_array.push(a)});var c=new THREE.ImageUtils.loadTexture(t._ASSETS_PATH_+"water/waternormals.jpg");c.wrapS=c.wrapT=THREE.RepeatWrapping;var h=new THREE.DirectionalLight(16777045,1);h.position.set(-600,300,600),this.scene.add(h),this.water=new THREE.Water(this.renderer,this.camera,this.scene,{textureWidth:256,textureHeight:256,waterNormals:c,alpha:1,sunDirection:h.position.normalize(),sunColor:16777215,waterColor:7695,betaVersion:0,side:THREE.DoubleSide,distortionScale:50});var d=new THREE.Mesh(new THREE.PlaneGeometry(2e4,2e4,100,100),this.water.material);d.position.y=-600,d.add(this.water),d.rotation.x=.5*-Math.PI,this.scene.add(d);new i.Terrain(function(t){e.scene.add(t),e.loadedIncrements(),e.grounds_collision_array.push(t)}),new a.Skybox(function(t){e.scene.add(t),e.loadedIncrements()});this.user_character=new s.Ratamahatta(1,function(t){t.position.y+=1e3,t.name="player",e.scene.add(t),e.camera.position.z=-50,e.camera.position.y=30,e.camera.lookAt(new THREE.Vector3(0,20,0)),t.add(e.camera),t.velocity=new THREE.Vector3(0,0,0),e.loadedIncrements()}),this.render_target_array.push(this.user_character)},resize:function(){e.trace_func("TestScene::resize"),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()},mousedown:function(e){if("attack"!=this.cur_anim_name){this.cur_anim_name="attack",this.user_character.setAnimation("attack"),this.attack_delta=20;var t=new THREE.Projector,r=e.target.getBoundingClientRect(),n=e.clientX-r.left,i=e.clientY-r.top;n=n/window.innerWidth*2-1,i=2*-(i/window.innerHeight)+1,this.scene.updateMatrixWorld(!0);var a=new THREE.Vector3;a.setFromMatrixPosition(this.camera.matrixWorld),console.log(n+","+i+"/"+this.camera.position.x+","+this.camera.position.y+","+this.camera.position.z);var s=new THREE.Vector3(n,i,1);t.unprojectVector(s,this.camera);for(var o=new THREE.Raycaster(a,s.sub(a).normalize()),c=0;c<this.monsters_array.length;c++){var h=this.monsters_array[c].getRatamahatta(),d=o.intersectObjects(h.root.children);d.length>0&&console.log("何かにあたった"+h.root.name)}}}},{}),{get TestScene(){return h}}}),System.register("objects/debugfloor",[],function(){"use strict";var e=System.get("util"),t=(System.get("config"),function(t){e.trace_func("Debugbox::constructor"),this.callback_function=t,this.mesh=new THREE.Mesh(new THREE.PlaneGeometry(1e3,1e3),new THREE.MeshPhongMaterial({color:14737632})),this.mesh.rotation.x=Math.PI+Math.PI/2,this.mesh.receiveShadow=!0,this.callback_function(this.mesh)});return $traceurRuntime.createClass(t,{rendering:function(){}},{}),{get Debugfloor(){return t}}}),System.register("objects/enemies",[],function(){"use strict";var e=System.get("util"),t=System.get("config"),r=function(t,r){e.trace_func("Sprite::constructor"),this.callback_function=r,this.sprite=this.makeTextSprite(t,{fontsize:24,borderColor:{r:255,g:0,b:0,a:1},backgroundColor:{r:255,g:100,b:100,a:.8}}),this.callback_function(this.sprite)};$traceurRuntime.createClass(r,{getSprite:function(){return this.sprite},setPositionVector3:function(e){this.sprite.position.set(e.x,e.y,e.z)},setPosition:function(e,t,r){this.sprite.position.set(e,t,r)},rendering:function(){},updateSprite:function(e,t){void 0===t&&(t={});var r=(t.hasOwnProperty("fontface")?t.fontface:"Arial",t.hasOwnProperty("fontsize")?t.fontsize:18),n=t.hasOwnProperty("borderThickness")?t.borderThickness:4,i=t.hasOwnProperty("borderColor")?t.borderColor:{r:0,g:0,b:0,a:1},a=t.hasOwnProperty("backgroundColor")?t.backgroundColor:{r:255,g:255,b:255,a:1},s=this.context.measureText(e),o=s.width;this.context.fillStyle="rgba("+a.r+","+a.g+","+a.b+","+a.a+")",this.context.strokeStyle="rgba("+i.r+","+i.g+","+i.b+","+i.a+")",this.context.lineWidth=n,this.roundRect(this.context,n/2,n/2,o+n,1.4*r+n,6),this.context.fillStyle="rgba(0, 0, 0, 1.0)",this.context.fillText(e,n,r+n),this.texture.needsUpdate=!0},makeTextSprite:function(e,t){void 0===t&&(t={});var r=t.hasOwnProperty("fontface")?t.fontface:"Arial",n=t.hasOwnProperty("fontsize")?t.fontsize:18,i=t.hasOwnProperty("borderThickness")?t.borderThickness:4,a=t.hasOwnProperty("borderColor")?t.borderColor:{r:0,g:0,b:0,a:1},s=t.hasOwnProperty("backgroundColor")?t.backgroundColor:{r:255,g:255,b:255,a:1},o=document.createElement("canvas");this.context=o.getContext("2d"),this.context.font="Bold "+n+"px "+r;var c=this.context.measureText(e),h=c.width;this.context.fillStyle="rgba("+s.r+","+s.g+","+s.b+","+s.a+")",this.context.strokeStyle="rgba("+a.r+","+a.g+","+a.b+","+a.a+")",this.context.lineWidth=i,this.roundRect(this.context,i/2,i/2,h+i,1.4*n+i,6),this.context.fillStyle="rgba(0, 0, 0, 1.0)",this.context.fillText(e,i,n+i),this.texture=new THREE.Texture(o),this.texture.needsUpdate=!0;var d=new THREE.SpriteMaterial({map:this.texture,useScreenCoordinates:!1}),u=new THREE.Sprite(d);return u.scale.set(100,50,1),u},roundRect:function(e,t,r,n,i,a){e.beginPath(),e.moveTo(t+a,r),e.lineTo(t+n-a,r),e.quadraticCurveTo(t+n,r,t+n,r+a),e.lineTo(t+n,r+i-a),e.quadraticCurveTo(t+n,r+i,t+n-a,r+i),e.lineTo(t+a,r+i),e.quadraticCurveTo(t,r+i,t,r+i-a),e.lineTo(t,r+a),e.quadraticCurveTo(t,r,t+a,r),e.closePath(),e.fill(),e.stroke()}},{});var n=function(){this.name="",this.maxhp=100,this.hp=100,this.maxmp=0,this.mp=0,this.maxammo=10,this.ammo=10,this.status=null,this.character=null,this.target_positions_array=null,this.target_position_index=0,this.current_animation="idol",this.sprite=null,this.y_timing=10*Math.floor(Math.random()),this.timing=0};$traceurRuntime.createClass(n,{calcDistance:function(e,t,r,n){var i,a,s;return i=e-r,a=t-n,s=Math.sqrt(Math.pow(i,2)+Math.pow(a,2))},rendering:function(e,t){var r=new THREE.Vector3(this.target_positions_array[this.target_position_index].x,this.character.root.position.y,this.target_positions_array[this.target_position_index].z);this.character.root.lookAt(r);var n=this.calcDistance(this.character.root.position.x,this.character.root.position.z,r.x,r.z),i=200*e/10;if(this.character.root.translateZ(i),10>n&&(this.target_position_index+1>=this.target_positions_array.length?this.target_position_index=0:this.target_position_index++),this.timing==this.y_timing){var a=new THREE.Raycaster;a.ray.direction.set(0,-1,0);var s=new THREE.Vector3(this.character.root.position.x,this.character.root.position.y+200,this.character.root.position.z);a.ray.origin.copy(s);var o=a.intersectObjects(t);o.length>0&&(this.character.root.position.y=o[0].point.y+8)}this.sprite.updateSprite(" "+this.name+" HP:"+this.hp--+"/"+this.maxhp+" ",{fontsize:24,borderColor:{r:255,g:0,b:0,a:1},backgroundColor:{r:255,g:100,b:100,a:.8}}),this.sprite.setPosition(this.character.root.position.x,this.character.root.position.y+30,this.character.root.position.z),this.character.update(e),this.timing++,this.timing>10&&(this.timing=0)}},{});var i=function(i,a){e.trace_func("Enemies::constructor");var s={baseUrl:t._ASSETS_PATH_+"models/ogro/",body:"ogro-light.js",skins:["grok.jpg","ogrobase.png","arboshak.png","ctf_r.png","ctf_b.png","darkam.png","freedom.png","gib.png","gordogh.png","igdosh.png","khorne.png","nabogro.png"],weapons:[["weapon-light.js","weapon.jpg"]],animations:{move:"run",idle:"stand",jump:"jump",attack:"attack",crouchMove:"cwalk",crouchIdle:"cstand",crouchAttach:"crattack"},walkSpeed:350,crouchSpeed:175},o={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1};this.callback_function=a,this.characters=new Array,this.cloneCharacterRoots=new Array,this.sprites=new Array;for(var c=0;i>c;c++){var h=new THREE.MD2CharacterComplex;h.scale=1/3,h.controls=o;var d=new n;d.character=h,d.target_positions_array=new Array;for(var u=0;3>u;u++){var l=Math.floor(300*Math.random())+200,m=Math.floor(300*Math.random())+600;d.target_positions_array.push({x:l,z:m})}d.name="モンスター"+c;var p=new r(" "+d.name+" HP:"+d.hp+"/"+d.maxhp+" ",function(){});d.sprite=p,this.characters.push(d)}var g=new THREE.MD2CharacterComplex;g.scale=.5;var _=this;g.onLoadComplete=function(){for(var e=0;i>e;e++){var t=_.characters[e].character;t.shareParts(g),t.enableShadows(!0),t.setWeapon(0),t.setSkin(e),t.frontAcceleration=0,t.controls.moveForward=!0,t.root.position.x=Math.floor(300*Math.random())+200,t.root.position.y=300,t.root.position.z=Math.floor(300*Math.random())+600,_.cloneCharacterRoots.push(t.root),_.sprites.push(_.characters[e].sprite.getSprite())}_.callback_function(_.cloneCharacterRoots,_.sprites)},g.loadParts(s)};return $traceurRuntime.createClass(i,{rendering:function(e,t){for(var r=0;r<this.characters.length;r++)this.characters[r].rendering(e,t)}},{}),{get Enemies(){return i}}}),System.register("threefieldscene",[],function(){"use strict";var e=System.get("util"),t=(System.get("config"),System.get("objects/debugbox")),r=System.get("objects/shaderbox"),n=System.get("objects/terrain"),i=System.get("objects/skybox"),a=System.get("objects/ratamahatta"),s=(System.get("objects/debugfloor"),System.get("objects/enemies")),o=function(t){var r=this;e.trace_func("ThreefieldScene::constructor"),this.renderer,this.scene,this.camera,this.light,this.ambient,this.all_items=6,this.loaded_items=0,this.nextScene="own",this.render_target_array=new Array,this.clock,this.attack_delta=0,this.grounds_collision_array=new Array,this.player_status={maxhp:100,hp:100,maxmp:100,mp:100,maxammo:100,ammo:100,status:""},this.player_mesh,this.renderer=t,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(45,1,.1,2e4),this.camera.position.set(0,150,500),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.light=new THREE.SpotLight(16777215),this.light.position.set(100,500,0),this.light.angle=Math.PI/4,this.scene.add(this.light),this.ambient=new THREE.AmbientLight(3355443),this.scene.add(this.ambient),this.light.castShadow=!0,this.light.shadowMapWidth=1024,this.light.shadowMapHeight=1024,this.light.shadowCameraNear=10,this.light.shadowCameraFar=400,this.light.shadowCameraFov=30,this.light.shadowCameraVisible=!0,this.renderer.shadowMapEnabled=!0,this.world=new THREEFIELD.World,this.playerObjectHolder=new THREE.Object3D,this.playerObjectHolder.position.set(0,100,0),this.scene.add(this.playerObjectHolder);var n=1;this.playerController=new THREEFIELD.CharacterController(this.playerObjectHolder,n,this.world),this.playerController.movementSpeed=30,this.keyInputControl=new THREEFIELD.KeyInputControl,this.keyInputControl.addEventListener("movekeyhold",function(){r.playerController.isWalking=!0}),this.keyInputControl.addEventListener("movekeyrelease",function(){r.playerController.isWalking=!1
}),this.keyInputControl.addEventListener("jumpkeypress",function(){r.playerController.jump()}),this.playerController.addEventListener("startIdling",function(){r.user_character.setAnimation("stand")}),this.playerController.addEventListener("startWalking",function(){r.user_character.setAnimation("run")}),this.playerController.addEventListener("startJumping",function(){r.user_character.setAnimation("jump")}),this.gyroscopeCameraControl=new THREEFIELD.GyroscopeCameraControl(this.camera,this.playerObjectHolder,{el:this.renderer.domElement,offset:new THREE.Vector3(0,12,0),radius:60,minRadius:20,maxRadius:100}),this.loadObjects(),$(document.body).append('<div id="hud"></div>'),$("#hud").append('<div id="hud0"></div>'),$("#hud0").append('<span id="health">HP:'+this.player_status.hp+"/"+this.player_status.maxhp+"</span>"),$("#hud0").append('<span id="magicpoint">MP:'+this.player_status.mp+"/"+this.player_status.maxmp+"</span>"),$("#hud").append('<div id="hud1"></div>'),$("#hud1").append('<span id="ammo">AMMO:'+this.player_status.ammo+"/"+this.player_status.maxammo+"</span>"),$("#hud1").append('<span id="status">status:'+this.player_status.status+"</span>"),$("#hud").append('<div id="hud2"></div>'),$("#hud2").append('<span id="character_debug">debug:n/a</span>')};return $traceurRuntime.createClass(o,{destructor:function(){$("#hud").remove(),this.scene=null,delete this.scene},getLoadingStatus:function(){return this.all_items===this.loaded_items||0==this.loading?!0:!1},loadedIncrements:function(){this.loaded_items++,this.loaded_items===this.all_items&&(this.loading=!1,this.clock=new THREE.Clock)},getNextScene:function(){return this.nextScene},rendering:function(){var t=this.clock.getDelta(),r=this.gyroscopeCameraControl.getFrontAngle(),n=this.keyInputControl.getFrontAngle();this.playerController.frontAngle=360-r+n%360,this.player_mesh.rotation.y=THREE.Math.degToRad(360-r+n%360)+Math.PI,this.gyroscopeCameraControl.update(),this.world.step(t),this.light.position.set(this.playerController.object.position.x,this.playerController.object.position.y+300,this.playerController.object.position.z),this.light.target.position.set(this.playerController.object.position.x,this.playerController.object.position.y-100,this.playerController.object.position.z),this.attack_delta>=0&&this.attack_delta--,this.attack_delta<0&&"attack"==this.user_character.getAnimation()&&this.user_character.setAnimation(this.playerController.isWalking?"run":"stand");for(var i=0;i<this.render_target_array.length;i++)this.render_target_array[i].rendering(t,this.grounds_collision_array);this.updateHUD(),e.debug_board("delta: "+Math.floor(1e5*t)/1e5+"<br><br>person x:"+Math.floor(1e5*this.playerController.object.position.x)/1e5+" y:"+Math.floor(1e5*this.playerController.object.position.y)/1e5+" z:"+Math.floor(1e5*this.playerController.object.position.z)/1e5+"<br>info.memory.programs:"+this.renderer.info.memory.programs+"<br>info.memory.geometries:"+this.renderer.info.memory.geometries+"<br>info.memory.textures:"+this.renderer.info.memory.textures+"<br>info.render.calls:"+this.renderer.info.render.calls+"<br>info.render.vertices:"+this.renderer.info.render.vertices+"<br>info.render.faces:"+this.renderer.info.render.faces+"<br>info.render.points:"+this.renderer.info.render.points),this.renderer.render(this.scene,this.camera)},loadObjects:function(){{var e=this;new t.Debugbox(function(t){e.scene.add(t);var r=new THREEFIELD.Collider(t);e.world.add(r),e.loadedIncrements()})}SHADER_LOADER.load(function(t){var n=t.vertexShader.vertex,i=t.fragmentShader.fragment,a=new r.Shaderbox(n,i,function(t){t.position.y+=70,t.position.x+=120,e.scene.add(t),e.loadedIncrements()});e.render_target_array.push(a)}),this.terrain=new n.Terrain(function(t){e.scene.add(t),e.loadedIncrements();var r=new THREEFIELD.Collider(t);e.world.add(r),e.grounds_collision_array.push(t)});new i.Skybox(function(t){e.scene.add(t),e.loadedIncrements()});this.user_character=new a.Ratamahatta(.5,function(t){t.position.y-=1,t.name="player",e.scene.add(t),e.playerObjectHolder.add(t),e.player_mesh=t,e.playerController.object.position.x=83,e.playerController.object.position.y=200,e.playerController.object.position.z=716,e.loadedIncrements()}),this.render_target_array.push(this.user_character);var o=new s.Enemies(10,function(t,r){for(var n=0;n<t.length;n++)e.scene.add(t[n]);for(var n=0;n<r.length;n++)e.scene.add(r[n]);e.loadedIncrements()});this.render_target_array.push(o)},resize:function(){e.trace_func("TestScene::resize"),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()},mousedown:function(){"attack"!=this.user_character.getAnimation()&&(this.user_character.setAnimation("attack"),this.attack_delta=20)},updateHUD:function(){$("#health").html("HP:"+this.player_status.hp+"/"+this.player_status.maxhp),$("#magicpoint").html("MP:"+this.player_status.mp+"/"+this.player_status.maxmp),$("#ammo").html("AMMO:"+this.player_status.ammo+"/"+this.player_status.maxammo),$("#status").html("status:"+this.player_status.status),$("#character_debug").html("debug:n/a")}},{}),{get ThreefieldScene(){return o}}}),System.register("app",[],function(){"use strict";var e=System.get("util"),t=System.get("config"),r=System.get("startscene"),n=System.get("openingscene"),i=System.get("testscene"),a=System.get("threefieldscene"),s=function(){e.trace_func("App::constructor"),this.renderer,this.stats,this.currentSceneObject,this.renderer=Detector.webgl?new THREE.WebGLRenderer({antialias:!0}):new THREE.CanvasRenderer,Detector.webgl&&e.webgl_info(this.renderer);var n=window.innerWidth,i=window.innerHeight;this.renderer.setSize(n,i),this.renderer.setClearColor(0,1),document.getElementById("canvas").appendChild(this.renderer.domElement),this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.top="0px",this.stats.domElement.style.zIndex=100,document.body.appendChild(this.stats.domElement),t._DEBUG_MODE_&&$(document.body).append('<div id="debug_board" width="200" height="200">test<br>test2<br>test3<br></div>'),e.debug_board("Now Loading..."),this.currentSceneObject=new r.StartScene(this.renderer),this.resize(),this.mouseevent()};return $traceurRuntime.createClass(s,{run:function(){e.trace_func("App::run"),this.update()},update:function(){var t=this.currentSceneObject.getNextScene();if("own"!==t)switch(e.debug_board("Now Loading..."),t){case"startscene":this.currentSceneObject.destructor(),this.currentSceneObject=null,this.currentSceneObject=new r.StartScene(this.renderer);break;case"openingscene":this.currentSceneObject.destructor(),this.currentSceneObject=null,this.currentSceneObject=new n.OpeningScene(this.renderer);break;case"testscene":this.currentSceneObject.destructor(),this.currentSceneObject=null,this.currentSceneObject=new i.TestScene(this.renderer);break;case"threefieldscene":this.currentSceneObject.destructor(),this.currentSceneObject=null,this.currentSceneObject=new a.ThreefieldScene(this.renderer)}this.rendering(),this.stats.update()},rendering:function(){var e=this;60===t._FPS_?requestAnimationFrame(function(){e.update()}):setTimeout(function(){requestAnimationFrame(function(){e.update()})},1e3/t._FPS_),this.currentSceneObject.getLoadingStatus()===!0&&this.currentSceneObject.rendering()},resize:function(){var t=this;e.trace_func("App::resize"),$(window).resize(function(){var r=window.innerWidth,n=window.innerHeight;e.trace_func("App::resize::resize w:"+r+",h:"+n),t.renderer.setSize(r,n),t.currentSceneObject.resize()})},mouseevent:function(){var t=this;$(document).mousedown(function(r){e.trace_func("App::mouseevent::mousedown - type"+r.type),t.currentSceneObject.mousedown(r)})}},{}),$(function(){e.i18nLoad(function(){e.trace_func($.i18n.t("app.i18nLoadComplete"));var t=new s;t.run()})}),{}}),System.get("app");